<!DOCTYPE html>
<html>
    <head>
        <title>My App</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
        <link rel="stylesheet" href="app.min.css">
        <style>

        /* styytling for the event block items */
        .eventDate {

            color: grey;

        }
        .eventTitle {

        }
        .eventDesc {

        }
        .eventLocation {

        }
        .eventHost {

            color: grey;

        }
        .eventSegment {

        }
        #locationMarker {
            width: 20px;
            height: 20px;
        }
        .dateBanner {
            text-align: center;
            background-color: black;
            color: white !important;
        }
        .refresh {
            background-color: orange;
            color: white;
        }

        </style>

        <!-- recaptcha-->
        <script src='https://www.google.com/recaptcha/api.js'></script>

    </head>

    <body>
        <div class="app-page" data-page="mainPage">

            <div class="app-topbar blue">
                <div class="app-title">What's On?</div>

                <!-- a button to logout -->
                <div class="right app-button" id="logoutButton">Log Out</div>

            </div>

            <!-- the main page where the events will go -->
            <div class="app-content" id="mainPageBody">

            </div>
        </div>

        <!-- a page where the user can login -->
        <div class="app-page" data-page="home">

            <!-- the top bar of the app -->
            <div class="app-topbar blue">
                <div class="app-title">Login</div>
            </div>

            <!-- the main content of the page -->
            <div class="app-content">

                <!-- an app section that will be populated with text if there is an issue with the input -->
                <p class="app-section" id="errorField"></p>

                <!-- an app section for the login form -->
                <div class="app-section">

                    <!-- an input for the user's email -->
                    <input id="emailInput" class="app-input" name="email" type="email" placeholder="Enter Email" />

                    <!-- an input for the password -->
                    <input id="passwordInput" class="app-input" name="password" type="password" placeholder="Enter Password" />

                    <!-- a login button -->
                    <div class="app-button green" id="submitButton">Access Edutix</div>

                </div>

            </div>
        </div>

    <!-- jquery script -->
    <script src="zepto.js"></script>
    <script src="app.min.js"></script>
    <script>

    App.controller('mainPage', function (page) {
        // an ajax request to check if a user is currently logged in
        $.ajax({

            type: "POST",
            url: "scripts/authenticate.php",
            data: "",
            success: function(html) {

                // check if the user isn't authenticated
                if (html != "true") {

                    // redirect the user
                    App.load("home");

                }
            }

        })

        // function that is executed when the logout button is pressed
        $(page).find("#logoutButton").clickable().on('click', function() {
            // run an ajax script that will log the user out
            $.ajax({

                type: "POST",
                url: "scripts/logout.php",
                data: "",
                success: function(html) {

                    // check if the user was logged out
                    if (html == "success") {

                        // redirect the user
                        App.load("home");

                    }
                }

            })

        });

        $(page).on("appShow", function () {

            // an ajax call to load up all of the events
            $.ajax({
                type: "POST",
                url: "scripts/fetchEvents.php",
                data: "startOffset=0",
                success: function(html) {

                    // if there are no events to show display this to the user
                    if (html == "none") {
                        $(page).find("#mainPageBody").html("<p class='app-section'>Sorry, there aren't any events to show</p>");
                    }
                    else if (html == "error" || html == "")  {
                        // if there was an error tell the user this
                        $(page).find("#mainPageBody").html("<p class='app-section'>Sorry, were having some trouble fetching the events. Please try again later.</p>");
                    }
                    else {
                        // turn the output into a javascript array
                        var events = JSON.parse(html);

                        // initialise the datebanner to be yesterday
                        var oldDate = new Date();
                         oldDate.setDate(oldDate.getDate()-1);

                        // loop through each value in this array
                        for (var event = 0; event < events.length; event++) {

                            var date = new Date(events[event][3]);

                            // check if this date is greater than the current day we are on
                            if (date > oldDate) {
                                // generate a new banner for this day
                                var dateToUse = date.toDateString().slice(0,-5);
                                $(page).find("#mainPageBody").append("<p class='app-section dateBanner'>"+dateToUse+"</p>");

                                // set this as the old date
                                oldDate = date;
                            }

                            date = date.toDateString().slice(0,-5);

                            // prepare the div we will insert
                            var divToInsert = $('<div class="app-section" data-id='+events[event][0]+'><h4 class="eventDate eventSegment">'+date+'</h4><h2 class="eventTitle eventSegment">'+events[event][1]+'</h2><h4 class="eventHost eventSegment">By '+events[event][5]+'</h4><h3 class="eventDesc eventSegment">'+events[event][2]+'</h3><h3 class="location eventSegment"><img src="marker.png" id="locationMarker"/>'+events[event][4]+'</h3></div>');

                            // insert a div into the page for this event
                            $(page).find("#mainPageBody").append(divToInsert);

                        }
                    }

                }

            })

        })

    });

    App.controller("home", function (page) {

        // initially hide the errors box
        $(page).find("#errorField").hide();

        // make the login button clickable (function that executes when the button is pressed)
        $(page).find("#submitButton").clickable().on('click', function() {

            // check if any of the fields are empty
            if ($(page).find("#passwordInput").val() == "" || $(page).find("#emailInput").val() == "") {

                // if they are add this to the error div
                $(page).find("#errorField").html("Error - One or more of the fields are empty");

                // show the field
                $(page).find("#errorField").show();

            }
            else {

                // check if the email is valid
                var pattern = new RegExp(/^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i);
                if (!pattern.test($(page).find("#emailInput").val())) {

                    // if they are add this to the error div
                    $(page).find("#errorField").html("Error - Invalid Email");

                    // show the field
                    $(page).find("#errorField").show();

                }
                else {
                    // try to login the user with via ajax request
                    $.ajax({

                        type: "POST",
                        url: "scripts/login.php",
                        data: "username="+$(page).find("#emailInput").val()+"&password="+$(page).find("#passwordInput").val(),
                        // function that will execute before the data is sent
                        beforeSend: function () {
                            // change the button to loading
                            $(page).find("#submitButton").html("Loading...");
                        },
                        success: function(html) {

                            // check if the login was a success
                            if (html == "success") {

                                // go to the homepage
                                App.load('mainPage');

                            }
                            else {

                                // else spit an error message
                                $(page).find("#errorField").html(html);

                                // show the field
                                $(page).find("#errorField").show();

                                // change the button again
                                $(page).find("#submitButton").html("Access Edutix");

                            }
                        }

                    })

                }
                return false;
            }
        });
    });

    try {
        App.restore();
    } catch (err) {
        App.load('mainPage');
    }
    </script>
  </body>
</html>
